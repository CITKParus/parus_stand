# Сервер стенда

* Взаимодействие с ПП Парус 8
* Обработка запросов Telegram-бота
* Обработка запросов сервиса печати
* Взаимодействие с вендинговым автоматом

Сервер возвращает JSON-ответ в формате:
```
{    
    "state": КОД_СОСТОЯНИЯ,
    "message": СООБЩЕНИЕ / ДАННЫЕ_ОТВЕТА
}
```
Где:

*state* - Код состояния ответа сервера. Принимает значения "OK" (успех) или "ERR" (ошибка). В случае, если состояние имеет значение "ERR", в "message" - содержится сообщение об ошибке. Для состояния "OK" поле "message" содержит данные ответа.

*message* - Сообщение об ошибке, или данные ответа (как правило JSON-объект), в зависимости от значения поля "state".


Каждый запрос к серверу должен содержать параметры *token* и *action*, указывающие на уникальный идентификатор клиента, осуществляющего запрос и код действия, соответственно.

### Функции сервера:

#### Получение состояния стенда (STAND_GET_STATE)
Способ передачи параметров: *POST, GET*


Параметры:

*token* - обязательный, строка, уникальный идентификатор клиента

*action* - обязательный, строка, принимает значение "STAND_GET_STATE"

Описание: возвращает сведения о номенклатурах, загруженных в вендинговый аппарат, их текущих остатках, динамике остатков, несколько последних сообщений в очереди уведомлений стенда, интегральное состояние остатков в вендинговой машине (много, заканчивается товар, аппарат пуст)


### Аутентификация пользователя по штрих-коду (AUTH_BY_BARCODE)
Способ передачи параметров: *POST, GET*


Параметры:

*token* - обязательный, строка, уникальный идентификатор клиента

*action* - обязательный, строка, принимает значение "AUTH_BY_BARCODE"

*barcode* - обязательный, строка, штрих-код посетителя стенда

Описание: по полученному штрих-коду посетителя возвращает сведения о нём (рег. номер контрагента в ПП Парус 8, его мнемокод, наименование), а так же описание текущего состояния остатков вендингового аппарата (текущие товарные запасы по местам хранения)


### Запрос на отгрузку товара из вендингового автомата (SHIPMENT)
Способ передачи параметров: *POST, GET*


Параметры:

*token* - обязательный, строка, уникальный идентификатор клиента

*action* - обязательный, строка, принимает значение "SHIPMENT"

*customer* - обязательный, строка, мнемокод контрагента-посетителя стенда

*rack_line* - обязательный, число, номер яруса стеллажа стенда (стенд, это склад с одним стеллажом, разбитым на ярусы)

*rack_line_cell* - обязательный, число, номер места хранения яруса стеллажа стенда (каждый ярус разбит на ячейки)

Описание: Создаёт на сервере ПП Парус 8 складской документ типа "Расходная накладная на отпуск потребителям" для контрагента-посетителя. При создании документа так же указывается место списания тованого запаса со стеллажа. Документ отрабатывается как факт и производится списание с мест хранения. В очередь отложенного формирования отчетности ставится печатная форма документа. Отдаётся команда вендинговому аппарату на выдачу товара. В зависимости от настроек сервера ПП Парус 8 производится проверка (до выполнения всего бизнес-процесса) - получал ли данный посетитель товар ранее.


### Получение списка сообщений очереди уведомлений стенда (MSG_GET_LIST)
Способ передачи параметров: *POST, GET*


Параметры:

*token* - обязательный, строка, уникальный идентификатор клиента

*action* - обязательный, строка, принимает значение "MSG_GET_LIST"

*from* - необязательный, дата в формате "dd.mm.yyyy hh24:mi:ss", начало временного диапазона поступления запрашиваемых уведомлений, если не передана - не учитывается, т.е. выдаются все сообщения с начала поступления

*type* - необязательный, строка, тип запрашиваемых уведомлений, может принимать значения "NOTIFY" (уведомительные сообщения стенда), "RESTS" (уведомления об остатках стенда), "REST_PRC" (уведомления об остатках стенда в %), "PRINT" (сообщения очереди печати), если не передан - не учитывается, т.е. выдаются сообщения всех типов

*state* - необязательный, строка, состояние запрашиваемых уведомлений, может принимать значения: для типа "NOTIFY" - "NOT_SENDED", "SENDED"; для типа "PRINT" - "NOT_PRINTED", "PRINTED"; для остальных типов - "UNDEFINED", если не передан - не учитывается, т.е. выдаются сообщения в любых состояниях

*limit* - необязательный, число, ограничение по количеству выдаваемых сообщений, если не передано - не учитывается, т.е. выдаются все сообщения, удовлетворяющие критериям запроса

*order* - необязательный, число, порядок сортировки сообщений при запросе, принимает значения "1" - сначала выдавать старые, "-1" - сначала выдавать новые, если не передана - по умолчанию принимается за "1"

Описание: Каждая из бизнес функций, выполняемых на стенде (формирование отгрузочного документа, постановка отчета в очередь, загрузка стенда товаром) оставляет соответствующие сообщения в очереди уведомлений. Получить их можно вызовом этой функции. Так же, через очередь уведомлений сервисы стенда могут общаться между собой. Для помещения сообщения в очередь можно использовать функцию "MSG_INSERT", для удаления - "MSG_DELETE", для изменения состояния - "MSG_SET_STATE".


### Добавление сообщения в очередь уведомлений стенда (MSG_INSERT)
Способ передачи параметров: *POST, GET*


Параметры:

*token* - обязательный, строка, уникальный идентификатор клиента

*action* - обязательный, строка, принимает значение "MSG_INSERT"

*type* - обязательный, строка, принимает значения: "NOTIFY" (уведомительное сообщение, см. notifyType), "RESTS" (сообщение об остатках, в натуральном выражении), "REST_PRC" (сообщение об остатках, в %), "PRINT" (сообщение очереди печати)

*message* - обязательный, строка, текст сообщения (не может быть пустым)

*notifyType* - необязательный, строка, тип уведомительного ("NOTIFY") сообщения, принимает значения: "INFORMATION" (информация, по-умолчанию), "WARNING" (предупреждение), "ERROR" (сообщение об ошибке)

Описание: Добавляет новое сообщение в очередь с текущей датой и временем, указанным типом и текстом сообщения. Сообщению автоматически присваивается состояние: для типа "NOTIFY" - "NOT_SENDED"; для типа "PRINT" - "NOT_PRINTED"; для остальных типов - "UNDEFINED".


### Удаление сообщения из очереди уведомлений стенда (MSG_DELETE)
Способ передачи параметров: *POST, GET*


Параметры:

*token* - обязательный, строка, уникальный идентификатор клиента

*action* - обязательный, строка, принимает значение "MSG_DELETE"

*rn* - обязательный, число, уникальный идентификатор сообщения (приходит при вызове "MSG_GET_LIST" в поле "NRN" для каждого из сообщений)

Описание: Удаляет сообщение из очереди уведомлений стенда.


### Установка состояния сообщения в очереди уведомлений стенда (MSG_SET_STATE)
Способ передачи параметров: *POST, GET*


Параметры:

*token* - обязательный, строка, уникальный идентификатор клиента

*action* - обязательный, строка, принимает значение "MSG_SET_STATE"

*rn* - обязательный, число, уникальный идентификатор сообщения (приходит при вызове "MSG_GET_LIST" в поле "NRN" для каждого из сообщений)

*state* - обязательный, строка, устанавливаемое состояние сообщения, может принимать значения: для типа "NOTIFY" - "NOT_SENDED", "SENDED"; для типа "PRINT" - "NOT_PRINTED", "PRINTED"; для остальных типов - только "UNDEFINED"

Описание: Устанавливает состояние сообщения в очереди уведомлений стенда.


### Проверка состояния отчета в очереди печати (PRINT_GET_STATE)
Способ передачи параметров: *POST, GET*


Параметры:

*token* - обязательный, строка, уникальный идентификатор клиента

*action* - обязательный, строка, принимает значение "PRINT_GET_STATE"

*rn* - обязательный, число, уникальный идентификатор отчета в очереди (приходит при вызове "MSG_GET_LIST" в поле "SMSG" для каждого из сообщений типа "PRINT")

Описание: Проверяет состояние указанной позиции очереди печати, переданной в параметре "rn". Возвращает JSON-описание состояния позиции очереди (с указанием ошибки печати, если была и адресом для выгрузки если отчет готов). Если отчет уже обработан сервером печати, то для соответствующей позиции очереди уведомлений будет установлен статус "PRINTED". Дополнительно в очередь уведомлений стенда будут добавлены уведомления о готовности или ошибке печати накладной.


### Получение URL для выгрузки файла (DOWNLOAD_GET_URL)
Способ передачи параметров: *POST, GET*


Параметры:

*token* - обязательный, строка, уникальный идентификатор клиента

*action* - обязательный, строка, принимает значение "DOWNLOAD_GET_URL"

*fileType* - обязательный, строка, указывает на тип выгружаемого файла, принимает значение: "REPORT"

*fileRn* - обязательный, число, уникальный идентификатор выгружаемого файла указанного типа

Описание: Формирует URL для выгрузки файла указанного типа с сервера ПП парус 8.

